# Journal: 2026-02-12 — WireGuard Mesh, DMZ Design & Training Run 2

## Summary

Built the WireGuard inter-device mesh (7/7 devices), designed the PA-220 physical microsegmentation architecture, patched XPS WSL2 after the 25.10 upgrade, improved the training pipeline with checkpoint resume, and kicked off a fresh 50-epoch training run after yesterday's WSL reboot killed the first one at epoch 44.

## What Got Done

### WireGuard Mesh — `10.7.7.0/24`

Deployed a WireGuard mesh with pi0 as hub, independent from UDM's remote access VPN.

| Device | WG IP | Role |
|--------|-------|------|
| pi0 | 10.7.7.1 | Hub (server, port 51820) |
| pi1 | 10.7.7.12 | Peer |
| pi2 | 10.7.7.14 | Peer |
| XPS | 10.7.7.4 | Peer |
| ThinkStation | 10.7.7.6 | Peer |
| MacBook | 10.7.7.8 | Peer |
| iPhone | 10.7.7.10 | Peer |

**Design decisions:**
- Pi0 as hub instead of UDM — full control over config, logging, and iptables on the tunnel
- Separate subnet (`10.7.7.0/24`) to avoid collision with UDM WireGuard (`192.168.7.0/24`)
- `OneDrive/soho/wireguard/` as cross-device config distribution layer for iPhone and MacBook
- Post-DMZ cutover: pi1/pi2 endpoints switch from LAN IPs to Tailscale IPs (`100.114.94.18`)
- UDM SSH RSA key pushed to all Pis for out-of-band recovery

### PA-220 DMZ Architecture

Audited the existing PA-220 config (927 lines of old lab artifacts), backed it up, and designed a clean production topology.

**Physical microsegmentation — one Pi per PA-220 port:**

| Port | Zone | Subnet | Purpose |
|------|------|--------|---------|
| mgmt | — | 192.168.2.14/24 | Management on backbone |
| eth1/7 | untrust | 192.168.2.15/24 | Uplink to UDM |
| eth1/1 | dmz-mgmt | 192.168.21.0/24 | pi0 (monitoring, LDAP) |
| eth1/8 | dmz-services | 192.168.20.0/24 | pi1 (Grafana, GuardQuote) |
| eth1/2 | dmz-security | 192.168.22.0/24 | pi2 (SentinelNet inference) |

- Inter-zone deny by default
- Outbound NAT per DMZ zone
- KVM stays on UDM/Matrix backbone (survives PA-220 failure)
- Incremental cutover: pi0 first, Tailscale + WireGuard as safety net

Full bootstrap config written as PAN-OS set commands (`pa220-fresh-bootstrap.txt`).

### XPS WSL2 Post-Upgrade Fixes

Ubuntu 25.10 upgrade (kernel 6.6.87.2, Python 3.13.7, CUDA 13.1) broke several components:

- Recreated Python venv for 3.13.7
- Restored WireGuard config (`/etc/wireguard/wg0.conf`)
- Rebuilt `/etc/hosts` with mesh hostnames
- Reinstalled node_exporter 1.7.0, enabled systemd service
- Restored Vector config (`/etc/vector/vector.toml` → Loki)
- Reconnected Tailscale
- Restored SSH authorized_keys
- Set NOPASSWD sudo (`/etc/sudoers.d/rjgar`)
- Fixed PATH for `/usr/lib/wsl/lib` (nvidia-smi visibility)

Also set NOPASSWD sudo on ThinkStation (`/etc/sudoers.d/johnmarston`).

### Training Pipeline Improvements

Enhanced `train.py`:
- **Resume from checkpoint:** Auto-detects `best.pt` and resumes training (optimizer state, epoch, best accuracy all restored)
- **Periodic checkpointing:** Saves `epoch{N}_{acc:.2f}.pt` every 5 epochs alongside continuous `best.pt` updates
- Prevents losing 40+ epochs of work to a WSL reboot

### Training Run 2

Previous run died at epoch 44/50 with 99.69% accuracy when WSL rebooted. Started fresh:

- **Config:** 50 epochs, batch 256, cosine annealing LR, patience 10
- **Hardware:** XPS RTX 4060 Ti (8GB VRAM), ~80 it/s
- **Status at EOD:** Epoch 17/50, train acc 98.65%, loss 0.0338
- **Validation:** Best val acc 98.69% at epoch 13, some instability (E16 dropped to 95.26% — likely cosine LR warm restart oscillation)
- **ETA:** ~56 minutes remaining
- **Expectation:** Should beat 99.32% (prev best checkpoint) around epoch 25-30

### Training Monitor

Built `sentinelnet-monitor.py` — SSH-based dashboard that polls the remote training log and displays:
- Epoch and batch progress bars
- Train loss, accuracy, speed
- ETA to completion
- Completed epoch validation history

## Artifacts

| File | Description |
|------|-------------|
| `docs/WIREGUARD.md` | Full WireGuard topology, peer table, operations runbook |
| `pa220-fresh-bootstrap.txt` | Clean PA-220 DMZ bootstrap config |
| `pa220-vandine-fw-config-backup.txt` | Old config backup (927 lines) |
| `wireguard-clients/iphone.conf` | iPhone WireGuard config |
| `wireguard-clients/macbook.conf` | MacBook WireGuard config |
| `sentinelnet-monitor.py` | Training monitor dashboard |

## What's Next

- [ ] Training completion → evaluate metrics across all 15 classes
- [ ] ONNX export → deploy real model to pi2 (replace dummy)
- [ ] Flash PA-220 with bootstrap config
- [ ] Cutover pi0 to dmz-mgmt zone (192.168.21.10/24)
- [ ] Adversarial robustness evaluation (FGSM, PGD, C&W)
- [ ] Monitoring stack design
